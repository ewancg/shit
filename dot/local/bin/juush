#!/usr/bin/env bash

REMOTE="https://m.ewan.green/uf"
CLIPBOARD=wl-copy
NOTIFY=notify-send

usage(){
    echo "Usage juush [-r URL] [-k key | -a] [-m mime] file"
    echo "This script allows you to upload to juush via commandline"
    echo ""
    echo "  -r REMOTE URL  Change remote url (default https://john2143.com/uf)"
    echo "                 \$HOME/.ssh/juushkey is used."
    echo "  -a             Upload as anonymous"
    echo "  -m mime        Use this mimetype instead"
    echo "  -x             Pipe to xclip -selection clipboard instead of stdout"
    exit 1
}

echoerr(){
    echo $@ >&2
}

while test $# != 0
do
    case "$1" in
    -a) ANON_UPLOAD=1;;
    -r) REMOTE=$2; shift;;
    -m) MIME_TYPE=$2; shift;;
    -x) XCLIP=1;;
    --) shift; break;;
    -*) echo "Unknown option $1"; usage;;
    *) FILE=$1;;
    esac
    shift
done

JUUSH_KEY=$(< "$HOME/.juushkey")

if [[ -z $JUUSH_KEY ]]; then
    if [[ -z $ANON_UPLOAD ]] && [[ -e $KEYFILE ]]; then
        source $KEYFILE
        echoerr "Got key..."
    else
        JUUSH_KEY="ZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZZ"
        echoerr "Anon upload"
    fi
fi

unset payload
if [ -z "$FILE" ]; then
    echoerr "No file path provided, using stdin"
    export payload="$(< /dev/stdin)"
    MIME_TYPE='text/plain'
    unset FILE
elif [[ ! -f "$FILE" ]]; then
    echoerr "File '$FILE' does not exist"
    exit 1
fi

if [[ -z $MIME_TYPE ]]; then
    echoerr "Getting MIME"
    MIME_TYPE=$(file --mime-type $FILE | awk '{print $2}')
fi

echoerr "Starting upload"

unset filename
[ ! -z "$FILE" ] && [[ "$(basename $FILE)" =~ "." ]] || filename="filename=none.txt;"
URL=`printf "%s" "$payload" | curl -X POST --limit-rate 5M -F "$JUUSH_KEY=@${FILE:-"/dev/fd/0"};${filename}type=$MIME_TYPE" $REMOTE`
printf "$URL"
